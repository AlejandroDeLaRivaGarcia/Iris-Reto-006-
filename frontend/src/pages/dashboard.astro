---
import Layout from "../layouts/Layout.astro";
import UserHeader from "../components/dashboard/UserHeader.astro";
import SubscriptionCard from "../components/dashboard/SubscriptionCard.astro";
import ProfileModal from "../components/dashboard/ProfileModal";
import PhoneOnboarding from "../components/dashboard/PhoneOnboarding";
import StatusCard from "../components/dashboard/StatusCard.astro";

let subjects = [];
let error = null;

try {
  const API_URL = "http://127.0.0.1:4321/api";

  const response = await fetch(`${API_URL}/subjects`);
  if (response.ok) {
    subjects = await response.json();
  } else {
    console.error("Failed to fetch subjects SSR");
    error = "No se pudieron cargar las asignaturas.";
  }
} catch (e) {
  console.error("Error fetching subjects:", e);
  error = "Error de conexión con el servidor.";
}
---

<Layout title="Iris - Mi Dashboard">
  <div class="max-w-5xl mx-auto p-6 lg:p-12 relative">
    <UserHeader />

    <div class="grid lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2 space-y-6">
        <div
          class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200/60 dark:border-slate-800 overflow-hidden"
        >
          <div
            class="p-6 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50"
          >
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white">
              Mis Suscripciones
            </h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
              Elige las asignaturas para recibir notificaciones WhatsApp.
            </p>
          </div>

          <div class="p-6 grid gap-4 sm:grid-cols-2" id="subscription-grid">
            {
              error ? (
                <div class="col-span-2 text-red-500 text-center py-4">
                  {error}
                </div>
              ) : (
                subjects.map((subject) => (
                  <SubscriptionCard subject={subject} />
                ))
              )
            }
          </div>

          <div
            class="p-6 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-100 dark:border-slate-800 flex justify-end"
          >
            <span
              id="save-status"
              class="text-sm text-slate-500 dark:text-slate-400 italic opacity-0 transition-opacity duration-300"
              >Guardado</span
            >
          </div>
        </div>
      </div>

      {/* Status Card or other widgets can go here */}
      <div>
        <StatusCard />
      </div>
    </div>
  </div>

  {/* Islands for Modals */}
  <ProfileModal client:idle />
  <PhoneOnboarding client:load />
</Layout>

<script>
  import { api } from "../services/api";

  const cards = document.querySelectorAll(".subscription-card");
  const saveStatus = document.getElementById("save-status");

  function showSaving() {
    if (saveStatus) {
      saveStatus.innerText = "Guardando...";
      saveStatus.style.opacity = "1";
    }
  }

  function showSaved() {
    if (saveStatus) {
      saveStatus.innerText = "Guardado";
      setTimeout(() => {
        saveStatus.style.opacity = "0";
      }, 2000);
    }
  }

  function updateCardVisuals(card, isSubscribed) {
    const badge = card.querySelector(".subject-badge");
    const title = card.querySelector(".subject-name");
    const iconContainer = card.querySelector(".status-icon");
    const icon = card.querySelector(".check-icon");
    const decoration = card.querySelector(".bg-decoration");

    if (isSubscribed) {
      // Add Subscribed Styles
      card.classList.add(
        "border-indigo-600",
        "bg-indigo-50/50",
        "dark:bg-indigo-900/20",
        "shadow-md",
        "shadow-indigo-100",
        "dark:shadow-indigo-900/30"
      );
      card.classList.remove(
        "border-slate-100",
        "dark:border-slate-800",
        "bg-white",
        "dark:bg-slate-900",
        "hover:border-slate-300",
        "dark:hover:border-slate-700",
        "hover:shadow-sm"
      );

      badge.classList.add(
        "bg-indigo-100",
        "dark:bg-indigo-900/50",
        "text-indigo-700",
        "dark:text-indigo-300"
      );
      badge.classList.remove(
        "bg-slate-100",
        "dark:bg-slate-800",
        "text-slate-500",
        "dark:text-slate-400",
        "group-hover:bg-slate-200",
        "dark:group-hover:bg-slate-700"
      );

      title.classList.add("text-indigo-900", "dark:text-indigo-100");
      title.classList.remove(
        "text-slate-700",
        "dark:text-slate-300",
        "group-hover:text-slate-900",
        "dark:group-hover:text-white"
      );

      iconContainer.classList.add(
        "bg-indigo-600",
        "border-indigo-600",
        "scale-110"
      );
      iconContainer.classList.remove(
        "border-slate-300",
        "dark:border-slate-700",
        "bg-white",
        "dark:bg-slate-900",
        "group-hover:border-indigo-400",
        "dark:group-hover:border-indigo-500"
      );

      icon.classList.remove("scale-0");
      icon.classList.add("scale-100");

      decoration.classList.remove("hidden");
    } else {
      // Remove Subscribed Styles (Revert to default)
      card.classList.remove(
        "border-indigo-600",
        "bg-indigo-50/50",
        "dark:bg-indigo-900/20",
        "shadow-md",
        "shadow-indigo-100",
        "dark:shadow-indigo-900/30"
      );
      card.classList.add(
        "border-slate-100",
        "dark:border-slate-800",
        "bg-white",
        "dark:bg-slate-900",
        "hover:border-slate-300",
        "dark:hover:border-slate-700",
        "hover:shadow-sm"
      );

      badge.classList.remove(
        "bg-indigo-100",
        "dark:bg-indigo-900/50",
        "text-indigo-700",
        "dark:text-indigo-300"
      );
      badge.classList.add(
        "bg-slate-100",
        "dark:bg-slate-800",
        "text-slate-500",
        "dark:text-slate-400",
        "group-hover:bg-slate-200",
        "dark:group-hover:bg-slate-700"
      );

      title.classList.remove("text-indigo-900", "dark:text-indigo-100");
      title.classList.add(
        "text-slate-700",
        "dark:text-slate-300",
        "group-hover:text-slate-900",
        "dark:group-hover:text-white"
      );

      iconContainer.classList.remove(
        "bg-indigo-600",
        "border-indigo-600",
        "scale-110"
      );
      iconContainer.classList.add(
        "border-slate-300",
        "dark:border-slate-700",
        "bg-white",
        "dark:bg-slate-900",
        "group-hover:border-indigo-400",
        "dark:group-hover:border-indigo-500"
      );

      icon.classList.add("scale-0");
      icon.classList.remove("scale-100");

      decoration.classList.add("hidden");
    }
  }

  const storedUserStr = localStorage.getItem("irisUser");
  let user = storedUserStr ? JSON.parse(storedUserStr) : null;

  async function initDashboard() {
    if (!user) return; // Should be handled by UserHeader redirect, but safety first

    if (!user.subjects) {
      try {
        const dbUser = await api.getUser(user.email);
        if (dbUser) {
          user = { ...user, ...dbUser };
          localStorage.setItem("irisUser", JSON.stringify(user));
        } else {
          user.subjects = [];
        }
      } catch (e) {
        console.error("Error fetching user details:", e);
        user.subjects = user.subjects || [];
      }
    }

    const subscribedCodes = new Set((user.subjects || []).map((s) => s.code));

    cards.forEach((card) => {
      const id = card.getAttribute("data-subject-id");
      const isSubscribed = subscribedCodes.has(id);
      updateCardVisuals(card, isSubscribed);

      card.addEventListener("click", async () => {
        showSaving();
        const currentlySubscribed = subscribedCodes.has(id);
        const newSubscribedState = !currentlySubscribed;

        updateCardVisuals(card, newSubscribedState);
        if (newSubscribedState) {
          subscribedCodes.add(id);
        } else {
          subscribedCodes.delete(id);
        }

        try {
          const newSubjectList = Array.from(subscribedCodes);
          const updatedUser = await api.updateSubscription({
            email: user.email,
            name: user.name,
            phone: user.phone || "",
            subjects: newSubjectList,
          });

          user = { ...user, ...updatedUser };
          localStorage.setItem("irisUser", JSON.stringify(user));
          showSaved();
        } catch (err) {
          console.error("Failed to update subscription", err);
          updateCardVisuals(card, currentlySubscribed);
          if (currentlySubscribed) subscribedCodes.add(id);
          else subscribedCodes.delete(id);
          alert("Error al guardar la suscripción.");
        }
      });
    });
  }

  // Run initialization
  initDashboard();
</script>
